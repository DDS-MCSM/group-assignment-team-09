---
title: "Práctica Team 09: Busqueda en Shodan de Vulnerabilidades del año pasado"
author: 
- name: "Juan José Sanz Martín"
- name: "Alberto López Millán"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
  filter_year: "2018"
  filter_score: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción

### La Pregunta

## Configurar Token de R Shodan

Ejecutando el codigo incluido se abrira el fichero .Renviron
En ese archivo hay que almacenar el token con formato: SHODAN_API_KEY = "<token>" y reiniciar R Studio

```{r rshodan_token, include=FALSE}
usethis::edit_r_environ()
```


## Obtener CVEs

Importar las funciones para crear el data frame de CVEs `./R/cves_filter.R`.

```{r file_load_cves, error=TRUE}
source("../R/cves.R")
```

### 1.1 Obtención de los CVEs

CVEs Data Frame de https://github.com/r-net-tools/security.datasets/raw/master/net.security/sysdata.rda

Filtros:

- Access Vector: Network
- Score >= 8
- Year == 2018


```{r df_cves, include=TRUE}
cves_full <- RetrieveCVEs()
cves <- FilterCVEsByYear(cves_full, params$filter_year)
cves <- FilterCVEsByAccessVectorNetwork(cves)
cves <- FilterCVEsByScore(cves, params$filter_score)

# Remove Rows containing NAs in important columns
cves <- FilterNAs(cves)

# Create a df containing only CVEs with scope 10
cves_score_10 <- FilterCVEsByScore(cves, 10) 


# unique(cves[,"cvss3.av"])
# unique(cves$cvss3.av)
```

### Graficas de CVEs

CVEs filtrados y representados por fecha de publicación y clasificados por su score.

```{r df_cves_plot, include=TRUE}

PlotCVEsByPublishedDate(cves)

```


```{r df_cves_score_plot, include=TRUE}

PlotPieChartCVEsByScore(cves)

```

## Obtener CPEs

Según la espeficicación de Mitre, que se puede consultar en https://cpe.mitre.org/files/cpe-specification_2.1.pdf

Part Component
The first component in a CPE Name is a single letter code that designates the particular platform
part that is being identified. The following codes are defined for CPE 2.0.
 h = hardware part
 o = operating system part
 a = application part
Additional character codes may be added as necessary in a future version of this specification.
For example, maybe 'd' for driver, 'l' for library, 'r' for runtime environment, or v for
virtualization. 

De esta forma, para nuestro caso y por simplificar las busquedas que se realizarán en Shodan, filtraremos los CPEs quedandonos únicamente con los codes "(h, o , a)"


```{r cpe_functions, error=TRUE}
cpes <- ExtractCPE2(cves)
cpes_score_10 <- ExtractCPE2(cves_score_10)

# Filtra: CPE part: 
# filtra según el tag "part component"  h = hardware part|o = operating system part|a = application part
cpes_part_regex <- "h|o|a"
cpes <- FilterCPEsByPartComponent(cpes, cpes_part_regex)
cpes_score_10 <- FilterCPEsByPartComponent(cpes_score_10, cpes_part_regex)

```
### Graficas de CPEs



```{r cpe_plots, error=TRUE}

PlotCPEssByVendor(cpes)

```

## Importar funciones de Shodan.io

Importar las funciones de Shodan.io `../R/shodan.R`.

Formato usado para las llamadas a Shodan vendor+product+version

```{r file_load_shodan, error=TRUE}
source("../R/shodan.R")
```

### Busqueda en Shodan


Creamos un texto para lanzar contra Shodan con los parametros de CPE:

+ Vendor Component
+ Product Component
+ Version Component

Ejemplo: juniper+junos+14.1x52


```{r shodan_search, include=TRUE}

#cpes_score_10
#cpes
cpes <- CPE_Create_Shodan_Query_Column(cpes)
cpes_score_10 <- CPE_Create_Shodan_Query_Column(cpes_score_10)

shodan_cpe_results <- CPE_Shodan_Search1(cpes)
if(!exists("shodan_cpe_results", inherits = FALSE)) {
  shodan_cpe_results <-  CPE_Shodan_Create_Empty_DF(cpes)
  i_init <- 1
  i_end  <- 10
  for(i in i_init:i_end) {
    
    ### Test con i = 4 ####
    results <- shodan_search(query=df$ShodanQuery[4])
    tmp_row <- rbind(cpes[c(4),])
    tmp_row$shodan_results <- results

    # Agrega fila al data frame final
    shodan_cpe_results <- rbind(tmp_row)
    
    

  }
  # Old code:  shodan_cpe_results <-  CPE_Shodan_Search(cpes, i_init = 1, i_end = 10)
  
}
if(!exists("shodan_cpe_results_score_10", inherits = FALSE)) {
  shodan_cpe_results_score_10 <- CPE_Shodan_Search(cpes_score_10)
}

# Shodan Search
#vendor="juniper"
#product="junos"
#version="14.1x53"
#shodan_res <- GetShodanResults(vendor, product, version)

```


### Representación de los datos de Shodan


```{r shodan_plot, include=TRUE}

# Shodan plot
PlotMapShodanResults(shodan_cpe_results_score_10$shodan_results[18])
PlotMapShodanResults(shodan_res)

```













```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
