---
title: "Práctica Team 09: Busqueda en Shodan de Vulnerabilidades del año pasado"
author: 
- name: "Juan José Sanz Martín"
- name: "Alberto López Millán"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
  filter_year: "2018"
  filter_score: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción

### La Pregunta

## Configurar Token de R Shodan

Ejecutando el codigo incluido se abrira el fichero .Renviron
En ese archivo hay que almacenar el token con formato: SHODAN_API_KEY = "<token>" y reiniciar R Studio

```{r rshodan_token, include=FALSE}
usethis::edit_r_environ()
```


## Obtener CVEs

Importar las funciones para crear el data frame de CVEs `./R/cves_filter.R`.

```{r file_load_cves, error=TRUE}
source("../R/cves.R")
```

### Obtención de los CVEs

CVEs Data Frame de [github/net.security/sysdata.rda](https://github.com/r-net-tools/security.datasets/raw/master/net.security/sysdata.rda)

Filtros:

- Access Vector: Network
- Score >= 8
- Year == 2018


```{r df_cves, include=TRUE}
cves_full <- RetrieveCVEs()
cves <- FilterCVEsByYear(cves_full, params$filter_year)
cves <- FilterCVEsByAccessVectorNetwork(cves)
cves <- FilterCVEsByScore(cves, params$filter_score)

# Remove Rows containing NAs in important columns
cves <- FilterNAs(cves)

# Create a df containing only CVEs with scope 10
cves_score_10 <- FilterCVEsByScore(cves, 10) 


# unique(cves[,"cvss3.av"])
# unique(cves$cvss3.av)
```

### Graficas de CVEs

CVEs filtrados y representados por fecha de publicación y clasificados por su score.

```{r df_cves_plot, include=TRUE}

PlotCVEsByPublishedDate(cves)

```


```{r df_cves_score_plot, include=TRUE}

PlotPieChartCVEsByScore(cves)

```

## Obtener CPEs

Según la espeficicación de Mitre para [CPEs](https://cpe.mitre.org/files/cpe-specification_2.1.pdf):

> Part Component
> The first component in a CPE Name is a single letter code that designates the particular platform
> part that is being identified. The following codes are defined for CPE 2.0.
>  h = hardware part
>  o = operating system part
>  a = application part
> Additional character codes may be added as necessary in a future version of this specification.
> For example, maybe 'd' for driver, 'l' for library, 'r' for runtime environment, or v for
> virtualization. 

De esta forma, para nuestro caso y por simplificar las busquedas que se realizarán en Shodan, filtraremos los CPEs quedandonos únicamente con los codes "(h, o , a)"


```{r cpe_functions, error=TRUE}
#cpes <- ExtractCPE(cves)
#cpes_score_10 <- ExtractCPE(cves_score_10)
#ExtractCPE2 corrección de Humbert, apply(cpes,2,class)  ::: todas las columnas eran listas
cpes <- ExtractCPE2(cves)
cpes_score_10 <- ExtractCPE2(cves_score_10)

# Filtra: CPE part: 
# filtra según el tag "part component"  h = hardware part|o = operating system part|a = application part
cpes_part_regex <- "h|o|a"
cpes <- FilterCPEsByPartComponent(cpes, cpes_part_regex)
cpes_score_10 <- FilterCPEsByPartComponent(cpes_score_10, cpes_part_regex)
remove(cpes_part_regex)

```
### Graficas de CPEs



```{r cpe_plots, error=TRUE}

PlotCPEssByVendor(cpes)

```

## Importar funciones de Shodan.io

Importar las funciones de Shodan.io `../R/shodan.R`.

Formato usado para las llamadas a Shodan vendor+product+version

```{r file_load_shodan, error=TRUE}
source("../R/shodan.R")
```

### Busqueda en Shodan


Creamos un texto para lanzar contra Shodan con los parametros de CPE:

+ Vendor Component
+ Product Component
+ Version Component

Ejemplo: juniper+junos+14.1x52

Lamentablemente por falta de tiempo y los siguientes errores no nos ha sido posible progresar en los siguientes puntos:

- Data.frame CPES contenia Listas que han producido multiples problemas tanto para obtener otros datos como para representar con ggplot
- Shodan limita el numero de req/sec a 1, con lo que al la hora de obtener los resultados devuelve un HTTP 502 y se corta el procesamiento. Hemos intentado dividir el procesamiento en trozos independientes pero por la falta de tiempo esto no se ha podido lograr. 


```{r shodan_search, include=TRUE}

#cpes_score_10
#cpes
cpes <- CPE_Create_Shodan_Query_Column(cpes)
cpes_score_10 <- CPE_Create_Shodan_Query_Column(cpes_score_10)

# ToDO:   
#saveRDS(object = shodan_cpe_results, file = "~/shodan.rds")
#loadRDS(object = shodan_cpe_results, file = "~/shodan.rds")
#save(cpes,file = "~/cpes.rds")
#load(file = "~/cpes.rds")



if(!exists("shodan_cpe_results", inherits = FALSE)) {
  shodan_cpe_results <- CPE_Shodan_Search1(cpes)
  
  #shodan_cpe_results <- CPE_Shodan_Search(cpes, forceShodanQuery = FALSE)
  #shodan_cpe_results <-  CPE_Shodan_Create_Empty_DF(cpes)
  remove(shodan_cpes_results)
  i_init <- 1
  i_end  <- 10
  #shodan_cpes_results <- CPE_Shodan_Search1(cpes)
  for(i in i_init:i_end) {
    
    #results <- shodan_search(query=df$ShodanQuery[1])
    i <- 1
    ### Test con i = 4 ####
    print(paste("Query:", i, cpes$ShodanQuery[i]))
    
    results <- GetShodanResults(query=cpes$ShodanQuery[i])
    
    print(paste("Num of results: ", results$total))
    
    cbind(cpes[c(i),],  results )
      
    tmp_row <- rbind(cpes[c(i),])
    tmp_row$ShodanResultsTotal <- as.integer(results$total)
    
    if( results$total > 0) {
      tmp_row <- cbind(tmp_row,as.data.frame(results$matches))
    }

    shodan_cpes_results <- rbind(cpes[c(i),], tmp_row,  fill=TRUE)
    remove(tmp_row)
    #tmp_row$shodan_results <- results
    
    #test2 <- cbind(cpes[c(4),],results$matches)
    

    # Agrega fila al data frame final
    #shodan_cpe_results <- rbind(tmp_row)
    #if(result$total == 0) {
      #shodan_cpes_results <- rbind(cbind(cpes[c(i),]))
    #}
    #else {
    #  shodan_cpes_results <- rbind(cbind(cpes[c(i),],results$matches))
    #}
    
    
    
    Sys.sleep(1)
    
    

  }
  # Old code:  shodan_cpe_results <-  CPE_Shodan_Search(cpes, i_init = 1, i_end = 10)
  
}
if(!exists("shodan_cpe_results_score_10", inherits = FALSE)) {
  shodan_cpe_results_score_10 <- CPE_Shodan_Search(cpes_score_10, 1, nrow(cpes_score_10))
}

# Shodan Search
#vendor="juniper"
#product="junos"
#version="14.1x53"
#shodan_res <- GetShodanResults(vendor, product, version)

```


### Representación de los datos de Shodan


```{r shodan_plot, include=TRUE}

# Shodan plot
PlotMapShodanResults(shodan_cpe_results_score_10$shodan_results[18])
PlotMapShodanResults(shodan_res)

```









